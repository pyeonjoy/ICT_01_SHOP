<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="review">
	<select id="count" resultType="int">
 		select count(*) from review 
 	</select>
 	<select id="review_list" parameterType="Map" resultType="rvo">
 		SELECT * 
			FROM review 
			WHERE user_idx = #{user_idx} 
			ORDER BY groups DESC, lev ASC 
			LIMIT #{limit} OFFSET #{offset}
 	</select>
 	
 	<!-- 입력하기전에 특정키값을 가져온 다음 그 값을 이용해서 처리하고 싶다.=> selectkey -->
 	<insert id="review_insert" parameterType="rvo">
 		<selectKey keyProperty="groups" resultType="String" order="BEFORE">
			SELECT (IFNULL(MAX(re_idx),0)+1) as groups FROM review
		</selectKey>
 		insert into review(user_idx,writer,title, content, pwd, hit, groups,step,lev, regdate, f_name)
 		values(#{user_idx},#{writer},#{title},#{content},#{pwd},0, #{groups},0,0, sysdate(), #{f_name})
 	</insert>
 	<update id="review_hit" parameterType="String">
 		update review set hit = hit + 1 where re_idx = #{re_idx} 
 	</update>
 	<select id="review_detail" parameterType="String" resultType="rvo">
 		select * from review where re_idx = #{re_idx}
 	</select>
 	<!-- lev update
 	    groups이 같으면서 레벨이 크거나 같으면 기본레벨을 증가 
 	 -->
 	 <update id="lev_update" parameterType="Map">
 	 	update review set lev=lev+1 where groups=#{groups} and lev>=#{lev} 
 	 </update>
 	 
 	 <insert id="ans_insert" parameterType="rvo">
 	 	insert into review(user_idx,writer,title, content, pwd, hit, groups,step,lev, regdate, f_name)
 		values(#{user_idx},#{writer},#{title},#{content},#{pwd},0, #{groups},#{step},#{lev}, sysdate(), #{f_name})
 	 </insert>
 	 
 	 <update id="review_delete" parameterType="rvo">
 	    <!-- 원글/댓글 active = 1 --> 
 	 	update review set active = 1 where re_idx = #{re_idx}
 	 </update>
 	 
 	 <delete id="review_ans_delete" parameterType="rvo">
 	 	delete from review where  re_idx = #{re_idx}
 	 </delete>
 	 <update id="review_update" parameterType="rvo">
 	 	update review 
 	 	set  writer=#{writer}, title=#{title}, content=#{content}, f_name=#{f_name}
 	 	where re_idx = #{re_idx}  	 
 	 </update>
</mapper>


